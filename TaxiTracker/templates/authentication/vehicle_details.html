<!DOCTYPE html>
<html lang="en">
{% load tz %}
{% get_current_timezone as TIME_ZONE %}
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <meta charset="UTF-8">
    <title>Vehicle Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .readonly-input {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        select[disabled] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    {% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}
    <h2>Детали автомобиля</h2>

    <form method="post" id="vehicleForm">
        {% csrf_token %}

        <div class="alert alert-info">
            <small>
                Current Enterprise: {{ ui_vehicle_details.enterprise.name }} (ID: {{ ui_vehicle_details.enterprise.id }})<br>
                Current Driver: {% if ui_vehicle_details.driver %}{{ ui_vehicle_details.driver.name }} (ID: {{ ui_vehicle_details.driver.id }}){% else %}Не назначен{% endif %}
            </small>
        </div>

        <table class="table table-bordered">
            <tr>
                <th>Дата выпуска</th>
                <td>
                    <input type="date" name="prod_date"
                           value="{{ ui_vehicle_details.prod_date|date:'Y-m-d' }}"
                           class="form-control readonly-input"
                           id="id_prod_date" readonly>
                </td>
            </tr>
            <tr>
                <th>Пробег</th>
                <td>
                    <input type="number" name="odometer"
                           value="{{ ui_vehicle_details.odometer }}"
                           class="form-control readonly-input"
                           id="id_odometer" readonly>
                </td>
            </tr>
            <tr>
                <th>Цена</th>
                <td>
                    <input type="number" name="price"
                           value="{{ ui_vehicle_details.price }}"
                           class="form-control readonly-input"
                           id="id_price" readonly>
                </td>
            </tr>
            <tr>
                <th>Цвет</th>
                <td>
                    <input type="text" name="color"
                           value="{{ ui_vehicle_details.color }}"
                           class="form-control readonly-input"
                           id="id_color" readonly>
                </td>
            </tr>
            <tr>
                <th>Номер</th>
                <td>
                    <input type="text" name="plate_number"
                           value="{{ ui_vehicle_details.plate_number }}"
                           class="form-control readonly-input"
                           id="id_plate_number" readonly>
                </td>
            </tr>
            <tr>
                <th>Бренд</th>
                <td>
                    <input type="text" name="brand"
                           value="{{ ui_vehicle_details.brand }}"
                           class="form-control readonly-input"
                           id="id_brand" readonly>
                    <input type="hidden" name="brand" value="{{ ui_vehicle_details.brand.id }}">
                </td>
            </tr>
        <tr>
            <th>Дата покупки</th>
            <td>
                {% if ui_vehicle_details.car_purchase_time_utc %}
                    {{ ui_vehicle_details.car_purchase_time_utc|localtime|date:"d.m.Y H:i" }}
                {% else %}
                    <span class="text-muted fst-italic">Дата покупки не указана</span>
                {% endif %}
            </td>
        </tr>
            <tr>
                <th>Предприятие</th>
                <td>
                    <div id="enterprise_display" class="mb-2">
                        {{ ui_vehicle_details.enterprise.name }}
                    </div>
                    <select name="enterprise" class="form-control readonly-input d-none"
                            id="id_enterprise" disabled>
                        <option value="">---------</option>
                        {% for enterprise in manager_enterprises %}
                            <option value="{{ enterprise.id }}"
                                {% if enterprise.id == ui_vehicle_details.enterprise.id %}selected{% endif %}>
                                {{ enterprise.name }}
                            </option>
                        {% empty %}
                            <option value="">Нет доступных предприятий</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <th>Водитель</th>
                <td>
                    <div id="driver_display" class="mb-2">
                        {% if ui_vehicle_details.driver %}
                            {{ ui_vehicle_details.driver.full_name }}
                        {% else %}
                            Не назначен
                        {% endif %}
                    </div>

                    <select name="driver" class="form-control readonly-input d-none"
                            id="id_driver" disabled>
                        <option value="">---------</option>
                        {% for driver in available_drivers %}
                            <option value="{{ driver.id }}"
                                {% if ui_vehicle_details.driver and driver.id == ui_vehicle_details.driver.id %}selected{% endif %}>
                                {{ driver.full_name }} ({{ driver.enterprise.name }})
                            </option>
                        {% empty %}
                            <option value="">Нет доступных водителей</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
        </table>

        <div class="mt-3">
            <button type="button" id="editBtn" class="btn btn-primary">Редактировать</button>
            <button type="submit" id="saveBtn" class="btn btn-success d-none">Сохранить</button>
            <a href="{% url 'vehicles' ui_vehicle_details.enterprise.id %}" class="btn btn-secondary">Назад к списку</a>
        </div>
    </form>
    <hr class="mt-5">

<h3>Поездки автомобиля</h3>

<form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
        <label class="form-label">С даты</label>
        <input type="datetime-local" name="start"
               value="{{ filter_start }}"
               class="form-control">
    </div>

    <div class="col-md-3">
        <label class="form-label">По дату</label>
        <input type="datetime-local" name="end"
               value="{{ filter_end }}"
               class="form-control">
    </div>

    <div class="col-md-3 align-self-end">
        <button type="submit" class="btn btn-primary">Фильтр</button>
        <a href="" class="btn btn-secondary">Сброс</a>
    </div>
</form>

<table class="table table-striped">
    <thead>
        <tr>
            <th></th>
            <th>ID</th>
            <th>Начало</th>
            <th>Конец</th>
        </tr>
    </thead>
    <tbody>
        {% for trip in trips %}
        <tr>
            <td>
                <input type="checkbox"
                       class="trip-checkbox"
                       value="{{ trip.id }}"
                       data-start="{{ trip.start_timestamp|date:'c' }}"
                       data-end="{{ trip.end_timestamp|date:'c' }}">
            </td>
            <td>{{ trip.id }}</td>
            <td>{{ trip.start_timestamp|localtime|date:"d.m.Y H:i" }}</td>
            <td>{{ trip.end_timestamp|localtime|date:"d.m.Y H:i" }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h4 class="mt-4">Карта поездок</h4>
<div id="map" style="height: 500px;"></div>

<nav>
    <ul class="pagination">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}&start={{ filter_start }}&end={{ filter_end }}">
                    Назад
                </a>
            </li>
        {% endif %}

        <li class="page-item active">
            <span class="page-link">
                {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
            </span>
        </li>

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}&start={{ filter_start }}&end={{ filter_end }}">
                    Вперёд
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
</div>

<script>
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const form = document.getElementById('vehicleForm');

    // Элементы для переключения между отображением и редактированием
    const enterpriseDisplay = document.getElementById('enterprise_display');
    const enterpriseSelect = document.getElementById('id_enterprise');
    const driverDisplay = document.getElementById('driver_display');
    const driverSelect = document.getElementById('id_driver');

    editBtn.addEventListener('click', () => {
        // Разблокируем все поля ввода
        form.querySelectorAll('input:not([type="hidden"])').forEach(field => {
            field.removeAttribute('readonly');
            field.classList.remove('readonly-input');
        });

        // Переключаем enterprise с отображения на select
        if (enterpriseDisplay && enterpriseSelect) {
            enterpriseDisplay.classList.add('d-none');
            enterpriseSelect.classList.remove('d-none');
            enterpriseSelect.removeAttribute('disabled');
        }

        // Переключаем driver с отображения на select
        if (driverDisplay && driverSelect) {
            driverDisplay.classList.add('d-none');
            driverSelect.classList.remove('d-none');
            driverSelect.removeAttribute('disabled');
        }

        editBtn.classList.add('d-none');
        saveBtn.classList.remove('d-none');
    });

        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    // Сохраняем в сессии через AJAX
    fetch("/set-timezone/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ timezone: userTimezone })
    });
const vehicleId = "{{ ui_vehicle_details.id }}";

let map = L.map('map').setView([55.75, 37.61], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let polylines = new Map();

function getRandomColor() {
    return "#" + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.trip-checkbox').forEach(checkbox => {

        checkbox.addEventListener('change', function() {

            const tripId = this.value;
            const start = this.dataset.start;
            const end = this.dataset.end;

            if (this.checked) {
                fetch(`/vehicle_trips/${vehicleId}/points_dashboard/?trip_id=${tripId}&start=${start}&end=${end}`)
                    .then(resp => {
                        if (!resp.ok) throw new Error("Ошибка загрузки точек");
                        return resp.json();
                    })
                    .then(data => {
                        const latlngs = data.points.map(p => [p.lat, p.lng]);
                        if (!latlngs.length) return;

                        const polyline = L.polyline(latlngs, {
                            color: getRandomColor(),
                            weight: 4
                        }).addTo(map);

                        polylines.set(this, polyline);
                        map.fitBounds(polyline.getBounds());
                    })
                    .catch(err => console.error(err));

            } else {
                if (polylines.has(this)) {
                    map.removeLayer(polylines.get(this));
                    polylines.delete(this);
                }
            }
        });
    });
});
</script>
</body>
</html>