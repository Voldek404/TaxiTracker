<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vehicle Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .readonly-input {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        select[disabled] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2>Детали автомобиля</h2>

    <form method="post" id="vehicleForm">
        {% csrf_token %}

        <!-- Отладочная информация (можно убрать после отладки) -->
        <div class="alert alert-info">
            <small>
                Vehicle ID: {{ ui_vehicle_details.id }}<br>
                Current Enterprise: {{ ui_vehicle_details.enterprise.name }} (ID: {{ ui_vehicle_details.enterprise.id }})<br>
                Current Driver: {% if ui_vehicle_details.driver %}{{ ui_vehicle_details.driver.name }} (ID: {{ ui_vehicle_details.driver.id }}){% else %}Не назначен{% endif %}
            </small>
        </div>

        <table class="table table-bordered">
            <tr>
                <th>ID</th>
                <td>{{ ui_vehicle_details.id }}</td>
            </tr>
            <tr>
                <th>Дата выпуска</th>
                <td>
                    <input type="date" name="prod_date"
                           value="{{ ui_vehicle_details.prod_date|date:'Y-m-d' }}"
                           class="form-control readonly-input"
                           id="id_prod_date" readonly>
                </td>
            </tr>
            <tr>
                <th>Пробег</th>
                <td>
                    <input type="number" name="odometer"
                           value="{{ ui_vehicle_details.odometer }}"
                           class="form-control readonly-input"
                           id="id_odometer" readonly>
                </td>
            </tr>
            <tr>
                <th>Цена</th>
                <td>
                    <input type="number" name="price"
                           value="{{ ui_vehicle_details.price }}"
                           class="form-control readonly-input"
                           id="id_price" readonly>
                </td>
            </tr>
            <tr>
                <th>Цвет</th>
                <td>
                    <input type="text" name="color"
                           value="{{ ui_vehicle_details.color }}"
                           class="form-control readonly-input"
                           id="id_color" readonly>
                </td>
            </tr>
            <tr>
                <th>Номер</th>
                <td>
                    <input type="text" name="plate_number"
                           value="{{ ui_vehicle_details.plate_number }}"
                           class="form-control readonly-input"
                           id="id_plate_number" readonly>
                </td>
            </tr>
            <tr>
                <th>Бренд</th>
                <td>
                    <input type="text" name="brand"
                           value="{{ ui_vehicle_details.brand }}"
                           class="form-control readonly-input"
                           id="id_brand" readonly>
                    <input type="hidden" name="brand" value="{{ ui_vehicle_details.brand.id }}">
                </td>
            </tr>
            <tr>
                <th>Предприятие</th>
                <td>
                    <div id="enterprise_display" class="mb-2">
                        {{ ui_vehicle_details.enterprise.name }}
                    </div>
                    <select name="enterprise" class="form-control readonly-input d-none"
                            id="id_enterprise" disabled>
                        <option value="">---------</option>
                        {% for enterprise in manager_enterprises %}
                            <option value="{{ enterprise.id }}"
                                {% if enterprise.id == ui_vehicle_details.enterprise.id %}selected{% endif %}>
                                {{ enterprise.name }}
                            </option>
                        {% empty %}
                            <option value="">Нет доступных предприятий</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            <tr>
                <th>Водитель</th>
                <td>
                    <div id="driver_display" class="mb-2">
                        {% if ui_vehicle_details.driver %}
                            {{ ui_vehicle_details.driver.full_name }}
                        {% else %}
                            Не назначен
                        {% endif %}
                    </div>

                    <select name="driver" class="form-control readonly-input d-none"
                            id="id_driver" disabled>
                        <option value="">---------</option>
                        {% for driver in available_drivers %}
                            <option value="{{ driver.id }}"
                                {% if ui_vehicle_details.driver and driver.id == ui_vehicle_details.driver.id %}selected{% endif %}>
                                {{ driver.full_name }} ({{ driver.enterprise.name }})
                            </option>
                        {% empty %}
                            <option value="">Нет доступных водителей</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
        </table>

        <div class="mt-3">
            <button type="button" id="editBtn" class="btn btn-primary">Редактировать</button>
            <button type="submit" id="saveBtn" class="btn btn-success d-none">Сохранить</button>
            <a href="{% url 'vehicles' ui_vehicle_details.enterprise.id %}" class="btn btn-secondary">Назад к списку</a>
        </div>
    </form>
</div>

<script>
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const form = document.getElementById('vehicleForm');

    // Элементы для переключения между отображением и редактированием
    const enterpriseDisplay = document.getElementById('enterprise_display');
    const enterpriseSelect = document.getElementById('id_enterprise');
    const driverDisplay = document.getElementById('driver_display');
    const driverSelect = document.getElementById('id_driver');

    editBtn.addEventListener('click', () => {
        // Разблокируем все поля ввода
        form.querySelectorAll('input:not([type="hidden"])').forEach(field => {
            field.removeAttribute('readonly');
            field.classList.remove('readonly-input');
        });

        // Переключаем enterprise с отображения на select
        if (enterpriseDisplay && enterpriseSelect) {
            enterpriseDisplay.classList.add('d-none');
            enterpriseSelect.classList.remove('d-none');
            enterpriseSelect.removeAttribute('disabled');
        }

        // Переключаем driver с отображения на select
        if (driverDisplay && driverSelect) {
            driverDisplay.classList.add('d-none');
            driverSelect.classList.remove('d-none');
            driverSelect.removeAttribute('disabled');
        }

        editBtn.classList.add('d-none');
        saveBtn.classList.remove('d-none');
    });
</script>
</body>
</html>